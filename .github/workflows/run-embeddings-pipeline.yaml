name: Run Embeddings Pipeline

on:
  workflow_call:
    inputs:
      data_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      data_version:
        description: 'Source data version tag (e.g., opencloudhub-readmes-v1.0.0)'
        required: true
        type: string

jobs:
  run-embeddings:
    name: üß† Run Embeddings Pipeline
    runs-on: self-hosted-local

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Install kubectl
        run: |
          if [ ! -f ~/.local/bin/kubectl ]; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mkdir -p ~/.local/bin
            mv kubectl ~/.local/bin/
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: üîê Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          kubectl cluster-info

      - name: üìù Update params.yaml
        run: |
          sed -i 's/version: ".*"/version: "${{ inputs.data_version }}"/' \
            pipelines/opencloudhub-readmes-embeddings/params.yaml

      - name: üß† Submit Ray Job (process stage)
        run: |
          cat <<EOF | kubectl create -f -
          apiVersion: ray.io/v1
          kind: RayJob
          metadata:
            generateName: readme-embeddings-
            namespace: mlops
            labels:
              pipeline: embeddings
          spec:
            entrypoint: "dvc repro pipelines/opencloudhub-readmes-embeddings/dvc.yaml --single-item process"
            shutdownAfterJobFinishes: true
            ttlSecondsAfterFinished: 600
            rayClusterSpec:
              rayVersion: "2.51.0"
              headGroupSpec:
                rayStartParams:
                  dashboard-host: "0.0.0.0"
                template:
                  spec:
                    containers:
                      - name: ray-head
                        image: opencloudhuborg/data-registry-pipelines:latest
                        resources:
                          requests:
                            cpu: "500m"
                            memory: "1Gi"
                          limits:
                            cpu: "1"
                            memory: "2Gi"
                        env:
                          - name: DATA_VERSION
                            value: "${{ inputs.data_version }}"
                          - name: DVC_REPO
                            value: "https://github.com/OpenCloudHub/data-registry.git"
                          - name: AWS_ACCESS_KEY_ID
                            valueFrom:
                              secretKeyRef:
                                name: minio-tenant-secret
                                key: accesskey
                          - name: AWS_SECRET_ACCESS_KEY
                            valueFrom:
                              secretKeyRef:
                                name: minio-tenant-secret
                                key: secretkey
                          - name: AWS_ENDPOINT_URL
                            value: "https://minio-api.internal.opencloudhub.org"
                          - name: PGVECTOR_HOST
                            value: "demo-app-db-rw.storage.svc.cluster.local"
                          - name: POSTGRES_DEMO_APP_DB_PASSWORD
                            valueFrom:
                              secretKeyRef:
                                name: demo-app-db-user
                                key: password
              workerGroupSpecs:
                - replicas: 1
                  groupName: worker
                  rayStartParams: {}
                  template:
                    spec:
                      containers:
                        - name: ray-worker
                          image: opencloudhuborg/data-registry-pipelines:latest
                          resources:
                            requests:
                              cpu: "500m"
                              memory: "1Gi"
                            limits:
                              cpu: "1"
                              memory: "2Gi"
                          env:
                            - name: DATA_VERSION
                              value: "${{ inputs.data_version }}"
                            - name: DVC_REPO
                              value: "https://github.com/OpenCloudHub/data-registry.git"
                            - name: AWS_ACCESS_KEY_ID
                              valueFrom:
                                secretKeyRef:
                                  name: minio-tenant-secret
                                  key: accesskey
                            - name: AWS_SECRET_ACCESS_KEY
                              valueFrom:
                                secretKeyRef:
                                  name: minio-tenant-secret
                                  key: secretkey
                            - name: AWS_ENDPOINT_URL
                              value: "https://minio-api.internal.opencloudhub.org"
                            - name: PGVECTOR_HOST
                              value: "demo-app-db-rw.storage.svc.cluster.local"
                            - name: POSTGRES_DEMO_APP_DB_PASSWORD
                              valueFrom:
                                secretKeyRef:
                                  name: demo-app-db-user
                                  key: password
          EOF

      - name: ‚è≥ Wait for Ray Job
        run: |
          sleep 5
          JOB_NAME=$(kubectl get rayjobs -n mlops -l pipeline=embeddings --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
          echo "üìã RayJob: $JOB_NAME"
          
          while true; do
            STATUS=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.jobStatus}' 2>/dev/null || echo "PENDING")
            echo "   Status: $STATUS"
            
            case "$STATUS" in
              "SUCCEEDED")
                echo "‚úÖ Process stage complete"
                break
                ;;
              "FAILED"|"STOPPED")
                echo "‚ùå Ray job failed"
                kubectl logs -n mlops -l ray.io/cluster=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.rayClusterName}') --tail=100 || true
                exit 1
                ;;
              *)
                sleep 15
                ;;
            esac
          done

      - name: üìä Run analyze stage (K8s Job)
        run: |
          cat <<EOF | kubectl create -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            generateName: embeddings-analyze-
            namespace: mlops
          spec:
            ttlSecondsAfterFinished: 300
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: analyze
                    image: opencloudhuborg/data-registry-pipelines:latest
                    command: ["python", "pipelines/opencloudhub-readmes-embeddings/scripts/analyze.py"]
                    env:
                      - name: DATA_VERSION
                        value: "${{ inputs.data_version }}"
                      - name: PGVECTOR_HOST
                        value: "demo-app-db-rw.storage.svc.cluster.local"
                      - name: POSTGRES_DEMO_APP_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: demo-app-db-user
                            key: password
                    resources:
                      requests:
                        cpu: "200m"
                        memory: "256Mi"
                      limits:
                        cpu: "500m"
                        memory: "512Mi"
          EOF

          sleep 3
          JOB_NAME=$(kubectl get jobs -n mlops --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
          echo "üìã Analyze Job: $JOB_NAME"

          kubectl wait --for=condition=complete --timeout=10m job/$JOB_NAME -n mlops || {
            echo "‚ùå Analyze job failed"
            kubectl logs -n mlops job/$JOB_NAME --tail=100
            exit 1
          }

          echo "‚úÖ Analyze complete"
          kubectl logs -n mlops job/$JOB_NAME

      - name: üíæ Commit and tag
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add pipelines/opencloudhub-readmes-embeddings/params.yaml
          git commit -m "chore: embeddings for ${{ inputs.data_version }} [skip ci]" || echo "No changes"
          
          VERSION=$(echo "${{ inputs.data_version }}" | grep -oP 'v[0-9]+\.[0-9]+\.[0-9]+')
          git tag -a "opencloudhub-readmes-embeddings-${VERSION}" \
            -m "Embeddings from ${{ inputs.data_version }}"
          
          git push || echo "Nothing to push"
          git push --tags || echo "No tags"

      - name: üìä Summary
        if: always()
        run: |
          echo "## üß† Embeddings Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source data:** \`${{ inputs.data_version }}\`" >> $GITHUB_STEP_SUMMARY