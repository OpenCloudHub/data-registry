name: Run Embeddings Pipeline

on:
  workflow_dispatch:
    inputs:
      dvc_data_version:
        description: 'DVC data version (e.g., "latest" or "opencloudhub-readmes-download-v1.0.0")'
        default: 'latest'
        type: string
      image_tag:
        description: 'Docker image tag (e.g., "latest" or "main-abc1234")'
        default: 'latest'
        type: string
      compute_type:
        description: 'Compute configuration'
        required: true
        type: choice
        options:
          - 'cpu-small'
          - 'cpu-medium'
          - 'cpu-large'
          - 'gpu-small'
          - 'gpu-medium'
          - 'gpu-large'
        default: 'cpu-medium'
      bump_type:
        description: 'Version bump type for output tag'
        type: choice
        options: ['patch', 'minor', 'major']
        default: 'patch'
      is_automated:
        description: 'Mark as automated run'
        type: boolean
        default: false

jobs:
  submit:
    name: üöÄ Submit Embeddings Pipeline
    runs-on: self-hosted-local
    steps:
      # =========================================================================
      # Setup
      # =========================================================================
      - name: üîß Setup kubectl
        uses: OpenCloudHub/.github/.github/actions/setup-kubectl@main
        with:
          kube-config: ${{ secrets.KUBE_CONFIG }}

      # =========================================================================
      # Resolve versions
      # =========================================================================
      - name: üìä Resolve DVC data version
        id: data
        uses: OpenCloudHub/.github/.github/actions/resolve-dvc-version@main
        with:
          dataset: opencloudhub-readmes-downloads
          version: ${{ inputs.dvc_data_version }}
          dvc-repo: ${{ vars.DVC_REPO_URL }}

      - name: üê≥ Resolve embeddings image
        id: image
        uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          token: ${{ secrets.DOCKER_TOKEN }}
          repo: ${{ secrets.DOCKER_USERNAME }}/data-registry-pipelines
          prefix: main
          tag: ${{ inputs.image_tag }}

      # =========================================================================
      # Submit workflow
      # =========================================================================
      - name: üöÄ Submit Argo Workflow
        id: submit
        run: |
          cat <<EOF | kubectl create -n mlops -f -
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: embeddings-pipeline-
            labels:
              repo: ${{ github.event.repository.name }}
              run-id: "${{ github.run_id }}"
              pipeline: "embeddings"
          spec:
            serviceAccountName: workflow-executor
            workflowTemplateRef:
              name: embeddings-pipeline
            arguments:
              parameters:
              - name: data_version
                value: "${{ steps.data.outputs.full-tag }}"
              - name: compute_type
                value: "${{ inputs.compute_type }}"
              - name: image
                value: "${{ steps.image.outputs.full-image }}"
              - name: bump_type
                value: "${{ inputs.bump_type }}"
              - name: is_automated
                value: "${{ inputs.is_automated }}"
          EOF

          # Get the actual workflow name
          sleep 2
          ACTUAL_NAME=$(kubectl get workflows -n mlops -l repo=${{ github.event.repository.name }},run-id=${{ github.run_id }} -o jsonpath='{.items[0].metadata.name}')
          echo "workflow_name=${ACTUAL_NAME}" >> $GITHUB_OUTPUT

      # =========================================================================
      # Summary
      # =========================================================================
      - name: üìä Summary
        run: |
          WORKFLOW_NAME=${{ steps.submit.outputs.workflow_name }}

          echo "========================================="
          echo "üöÄ EMBEDDINGS PIPELINE SUBMITTED"
          echo "========================================="
          echo ""
          echo "Workflow:      ${WORKFLOW_NAME}"
          echo "Data Version:  ${{ steps.data.outputs.full-tag }}"
          echo "Image:         ${{ steps.image.outputs.full-image }}"
          echo "Compute:       ${{ inputs.compute_type }}"
          echo "Bump Type:     ${{ inputs.bump_type }}"
          echo "Automated:     ${{ inputs.is_automated }}"
          echo ""
          echo "üìä MONITORING:"
          echo "  https://argo-workflows.internal.opencloudhub.org/workflows/mlops/${WORKFLOW_NAME}"
          echo "========================================="

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Embeddings Pipeline Submitted

          | Parameter | Value |
          |-----------|-------|
          | **Workflow** | \`${WORKFLOW_NAME}\` |
          | **Data Version** | \`${{ steps.data.outputs.full-tag }}\` |
          | **Image** | \`${{ steps.image.outputs.full-image }}\` |
          | **Compute** | \`${{ inputs.compute_type }}\` |
          | **Bump Type** | \`${{ inputs.bump_type }}\` |
          | **Automated** | \`${{ inputs.is_automated }}\` |

          ### üìä Monitoring

          - [Argo Workflow](https://argo-workflows.internal.opencloudhub.org/workflows/mlops/${WORKFLOW_NAME})
          EOF