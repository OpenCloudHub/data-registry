# .github/workflows/run-embeddings-pipeline.yaml
name: Run Embeddings Pipeline

on:
  workflow_call:
    inputs:
      data_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      data_version:
        description: 'Source data version tag (e.g., opencloudhub-readmes-v1.0.0)'
        required: true
        type: string

jobs:
  run-embeddings:
    name: ğŸ§  Run Embeddings Pipeline
    runs-on: self-hosted-local

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Install kubectl
        run: |
          if [ ! -f ~/.local/bin/kubectl ]; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mkdir -p ~/.local/bin
            mv kubectl ~/.local/bin/
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ” Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          kubectl cluster-info

      - name: ğŸ³ Build image
        run: docker build --target prod -t data-pipelines:local .

      - name: ğŸ“ Update params.yaml
        run: |
          sed -i 's/version: ".*"/version: "${{ inputs.data_version }}"/' \
            pipelines/opencloudhub-readmes-embeddings/params.yaml

      - name: ğŸ§  Submit Ray Job (process stage)
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: ray.io/v1
          kind: RayJob
          metadata:
            generateName: readme-embeddings-
            namespace: mlops
            labels:
              pipeline: embeddings
              data-version: "${DATA_VERSION}"
          spec:
            entrypoint: "dvc repro pipelines/opencloudhub-readmes-embeddings/dvc.yaml --single-item process"
            shutdownAfterJobFinishes: true
            ttlSecondsAfterFinished: 600
            rayClusterSpec:
              rayVersion: "2.51.0"
              headGroupSpec:
                rayStartParams:
                  dashboard-host: "0.0.0.0"
                template:
                  spec:
                    containers:
                      - name: ray-head
                        image: opencloudhuborg/data-registry-pipelines:latest
                        resources:
                          requests:
                            cpu: "500m"
                            memory: "1Gi"
                          limits:
                            cpu: "1"
                            memory: "2Gi"
                        env:
                          - name: DATA_VERSION
                            value: "${{ inputs.data_version }}"
                          - name: DVC_REPO
                            value: "https://github.com/OpenCloudHub/data-registry.git"
                          - name: AWS_ACCESS_KEY_ID
                            valueFrom:
                              secretKeyRef:
                                name: minio-tenant-secret
                                key: accesskey
                          - name: AWS_SECRET_ACCESS_KEY
                            valueFrom:
                              secretKeyRef:
                                name: minio-tenant-secret
                                key: secretkey
                          - name: AWS_ENDPOINT_URL
                            value: "https://minio-api.internal.opencloudhub.org"
                          - name: PGVECTOR_HOST
                            value: "demo-app-db-rw.storage.svc.cluster.local"
                          - name: POSTGRES_DEMO_APP_DB_PASSWORD
                            valueFrom:
                              secretKeyRef:
                                name: demo-app-db-user
                                key: password
              workerGroupSpecs:
                - replicas: 1
                  groupName: worker
                  rayStartParams: {}
                  template:
                    spec:
                      containers:
                        - name: ray-worker
                          image: opencloudhuborg/data-registry-pipelines:latest
                          resources:
                            requests:
                              cpu: "500m"
                              memory: "1Gi"
                            limits:
                              cpu: "1"
                              memory: "2Gi"
                          env:
                            - name: DATA_VERSION
                              value: "${{ inputs.data_version }}"
                            - name: DVC_REPO
                              value: "https://github.com/OpenCloudHub/data-registry.git"
                            - name: AWS_ACCESS_KEY_ID
                              valueFrom:
                                secretKeyRef:
                                  name: minio-tenant-secret
                                  key: accesskey
                            - name: AWS_SECRET_ACCESS_KEY
                              valueFrom:
                                secretKeyRef:
                                  name: minio-tenant-secret
                                  key: secretkey
                            - name: AWS_ENDPOINT_URL
                              value: "https://minio-api.internal.opencloudhub.org"
                            - name: PGVECTOR_HOST
                              value: "demo-app-db-rw.storage.svc.cluster.local"
                            - name: POSTGRES_DEMO_APP_DB_PASSWORD
                              valueFrom:
                                secretKeyRef:
                                  name: demo-app-db-user
                                  key: password
          EOF
        env:
          DATA_VERSION: ${{ inputs.data_version }}

      - name: â³ Wait for Ray Job
        run: |
          sleep 5
          JOB_NAME=$(kubectl get rayjobs -n mlops -l pipeline=embeddings --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
          echo "ğŸ“‹ RayJob: $JOB_NAME"
          
          while true; do
            STATUS=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.jobStatus}' 2>/dev/null || echo "PENDING")
            echo "   Status: $STATUS"
            
            case "$STATUS" in
              "SUCCEEDED")
                echo "âœ… Process stage complete"
                break
                ;;
              "FAILED"|"STOPPED")
                echo "âŒ Ray job failed"
                kubectl logs -n mlops -l ray.io/cluster=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.rayClusterName}') --tail=100 || true
                exit 1
                ;;
              *)
                sleep 15
                ;;
            esac
          done

      - name: ğŸ“Š Run analyze stage
        run: |
          mkdir -p data/opencloudhub-readmes-embeddings
          docker run --rm \
            -v ${{ github.workspace }}/data/opencloudhub-readmes-embeddings:/app/data/opencloudhub-readmes-embeddings \
            -e PGVECTOR_HOST=${{ secrets.PGVECTOR_HOST }} \
            -e POSTGRES_DEMO_APP_DB_PASSWORD=${{ secrets.POSTGRES_DEMO_APP_DB_PASSWORD }} \
            -e DATA_VERSION=${{ inputs.data_version }} \
            data-pipelines:local \
            python pipelines/opencloudhub-readmes-embeddings/scripts/analyze.py

      - name: ğŸ’¾ Commit and tag
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add data/opencloudhub-readmes-embeddings/metadata.json
          git add pipelines/opencloudhub-readmes-embeddings/params.yaml
          git commit -m "chore: embeddings for ${{ inputs.data_version }} [skip ci]" || echo "No changes"
          
          # Create embeddings tag matching source version
          VERSION=$(echo "${{ inputs.data_version }}" | grep -oP 'v[0-9]+\.[0-9]+\.[0-9]+')
          git tag -a "opencloudhub-readmes-embeddings-${VERSION}" \
            -m "Embeddings from ${{ inputs.data_version }}"
          
          git push || echo "Nothing to push"
          git push --tags || echo "No tags"

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ§  Embeddings Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source data:** \`${{ inputs.data_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f data/opencloudhub-readmes-embeddings/metadata.json ]; then
            echo "### ğŸ“ˆ Results" >> $GITHUB_STEP_SUMMARY
            cat data/opencloudhub-readmes-embeddings/metadata.json >> $GITHUB_STEP_SUMMARY
          fi