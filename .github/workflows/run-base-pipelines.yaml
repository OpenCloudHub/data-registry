# .github/workflows/data-pipelines.yaml
name: Run Data Pipelines

on:
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Pipeline to run (empty = all base pipelines)'
        type: choice
        options:
          - ''
          - 'emotion'
          - 'fashion-mnist'
          - 'wine-quality'
          - 'opencloudhub-readmes-download'
        default: ''
      bump_type:
        type: choice
        options: ['patch', 'minor', 'major']
        default: 'patch'
  schedule:
    - cron: '0 2 * * *'

jobs:
  run-pipelines:
    name: ðŸ”„ Run Data Pipelines
    runs-on: self-hosted-local
    outputs:
      readmes_tag: ${{ steps.run.outputs.readmes_tag }}

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ³ Build image
        run: docker build --target prod -t data-pipelines:local .

      - name: ðŸš€ Run pipeline(s)
        id: run
        run: |
          # Run and capture output
          docker run --rm \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e AWS_ENDPOINT_URL=${{ secrets.AWS_ENDPOINT_URL }} \
            -e BUMP_TYPE=${{ inputs.bump_type || 'patch' }} \
            -e IS_CRON=${{ github.event_name == 'schedule' }} \
            data-pipelines:local \
            bash -c '
              dvc remote modify minio access_key_id $AWS_ACCESS_KEY_ID
              dvc remote modify minio secret_access_key $AWS_SECRET_ACCESS_KEY
              if [ -n "${{ inputs.pipeline }}" ]; then
                dvc repro pipelines/${{ inputs.pipeline }}/dvc.yaml
              else
                bash scripts/run-all-base.sh  # excludes embeddingsena
              fi
            '
          
          # Check if readmes tag was created
          READMES_TAG=$(git tag -l "opencloudhub-readmes-v*" --sort=-version:refname | head -n1)
          echo "readmes_tag=$READMES_TAG" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit and push
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: update datasets [skip ci]" || echo "No changes"
          git push || echo "Nothing to push"
          git push --tags || echo "No tags"

  trigger-embeddings:
    name: ðŸ§  Trigger Embeddings
    needs: run-pipelines
    if: needs.run-pipelines.outputs.readmes_tag != ''
    uses: ./.github/workflows/run-embeddings-pipeline.yaml
    with:
      data_version: ${{ needs.run-pipelines.outputs.readmes_tag }}
    secrets: inherit