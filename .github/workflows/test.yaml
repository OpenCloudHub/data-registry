# .github/workflows/test-actions.yaml
# Test workflow to validate all custom actions work correctly
# Run manually to verify actions after changes

name: ðŸ§ª Test Custom Actions

on:
  workflow_dispatch:
    inputs:
      test-kubectl:
        description: 'Test setup-kubectl action'
        type: boolean
        default: true
      test-docker-tag:
        description: 'Test resolve-docker-tag action'
        type: boolean
        default: true
      test-dvc-version:
        description: 'Test resolve-dvc-version action'
        type: boolean
        default: true
      docker-repo:
        description: 'Docker repo to test (e.g., opencloudhuborg/wine-classifier-training)'
        type: string
        default: 'opencloudhuborg/data-registry-pipelines'
      docker-prefix:
        description: 'Docker tag prefix to test'
        type: string
        default: 'main'
      docker-tag:
        description: 'Docker tag to resolve (latest or specific)'
        type: string
        default: 'latest'
      dvc-dataset:
        description: 'DVC dataset to test'
        type: string
        default: 'wine-quality'
      dvc-version:
        description: 'DVC version to resolve (latest or specific like v1.0.0)'
        type: string
        default: 'latest'
      verify-dvc-remote:
        description: 'Verify DVC data exists in remote storage'
        type: boolean
        default: false

jobs:
  # ==========================================================================
  # Test: setup-kubectl
  # ==========================================================================
  test-kubectl:
    name: ðŸ”§ Test setup-kubectl
    runs-on: self-hosted-local
    if: inputs.test-kubectl
    steps:
      - name: ðŸ“‹ Test Info
        run: |
          echo "## ðŸ”§ Testing setup-kubectl" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run setup-kubectl action
        id: kubectl
        uses: OpenCloudHub/.github/.github/actions/setup-kubectl@main
        with:
          kube-config: ${{ secrets.KUBE_CONFIG }}
          verify: 'true'

      - name: âœ… Verify kubectl works
        run: |
          echo "kubectl path: ${{ steps.kubectl.outputs.kubectl-path }}"
          echo ""
          echo "Cluster info:"
          kubectl cluster-info
          echo ""
          echo "Namespaces:"
          kubectl get namespaces
          echo ""
          echo "### âœ… setup-kubectl passed" >> $GITHUB_STEP_SUMMARY
          echo "- kubectl path: \`${{ steps.kubectl.outputs.kubectl-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Cluster connection: verified" >> $GITHUB_STEP_SUMMARY


  # ==========================================================================
  # Test: resolve-docker-tag
  # ==========================================================================
  test-docker-tag:
    name: ðŸ³ Test resolve-docker-tag
    runs-on: self-hosted-local
    if: inputs.test-docker-tag
    steps:
      - name: ðŸ“‹ Test Info
        run: |
          echo "## ðŸ³ Testing resolve-docker-tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| repo | \`${{ inputs.docker-repo }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| prefix | \`${{ inputs.docker-prefix }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| tag | \`${{ inputs.docker-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run resolve-docker-tag action
        id: docker
        uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          token: ${{ secrets.DOCKER_TOKEN }}
          repo: ${{ inputs.docker-repo }}
          prefix: ${{ inputs.docker-prefix }}
          tag: ${{ inputs.docker-tag }}

      - name: âœ… Verify outputs
        run: |
          echo "Resolved tag: ${{ steps.docker.outputs.resolved-tag }}"
          echo "Full image: ${{ steps.docker.outputs.full-image }}"
          echo "Digest: ${{ steps.docker.outputs.digest }}"
          echo ""
          echo "### âœ… resolve-docker-tag passed" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| resolved-tag | \`${{ steps.docker.outputs.resolved-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| full-image | \`${{ steps.docker.outputs.full-image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| digest | \`${{ steps.docker.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Test: resolve-dvc-version
  # ==========================================================================
  test-dvc-version:
    name: ðŸ“Š Test resolve-dvc-version
    runs-on: self-hosted-local
    if: inputs.test-dvc-version
    steps:
      - name: ðŸ“‹ Test Info
        run: |
          echo "## ðŸ“Š Testing resolve-dvc-version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| dataset | \`${{ inputs.dvc-dataset }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| version | \`${{ inputs.dvc-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| verify-remote | \`${{ inputs.verify-dvc-remote }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run resolve-dvc-version action
        id: dvc
        uses: OpenCloudHub/.github/.github/actions/resolve-dvc-version@main
        with:
          dataset: ${{ inputs.dvc-dataset }}
          version: ${{ inputs.dvc-version }}
          dvc-repo: ${{ vars.DVC_REPO_URL }}
          verify-remote: ${{ inputs.verify-dvc-remote }}
          aws-access-key-id: ${{ inputs.verify-dvc-remote && secrets.AWS_ACCESS_KEY_ID || '' }}
          aws-secret-access-key: ${{ inputs.verify-dvc-remote && secrets.AWS_SECRET_ACCESS_KEY || '' }}
          aws-endpoint-url: ${{ inputs.verify-dvc-remote && vars.AWS_ENDPOINT_URL || '' }}

      - name: âœ… Verify outputs
        run: |
          echo "Resolved version: ${{ steps.dvc.outputs.resolved-version }}"
          echo "Full tag: ${{ steps.dvc.outputs.full-tag }}"
          echo "Dataset: ${{ steps.dvc.outputs.dataset }}"
          echo ""
          echo "### âœ… resolve-dvc-version passed" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| resolved-version | \`${{ steps.dvc.outputs.resolved-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| full-tag | \`${{ steps.dvc.outputs.full-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| dataset | \`${{ steps.dvc.outputs.dataset }}\` |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Test: All actions together (integration test)
  # ==========================================================================
  test-integration:
    name: ðŸ”— Integration Test
    runs-on: self-hosted-local
    if: inputs.test-kubectl && inputs.test-argo && inputs.test-docker-tag && inputs.test-dvc-version
    needs: [test-kubectl, test-argo, test-docker-tag, test-dvc-version]
    steps:
      - name: ðŸ“‹ Integration Test
        run: |
          echo "## ðŸ”— Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      # Setup infrastructure
      - name: ðŸ”§ Setup kubectl
        uses: OpenCloudHub/.github/.github/actions/setup-kubectl@main
        with:
          kube-config: ${{ secrets.KUBE_CONFIG }}

      # Resolve versions
      - name: ðŸ³ Resolve Docker image
        id: image
        uses: OpenCloudHub/.github/.github/actions/resolve-docker-tag@main
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          token: ${{ secrets.DOCKER_TOKEN }}
          repo: ${{ inputs.docker-repo }}
          prefix: ${{ inputs.docker-prefix }}
          tag: ${{ inputs.docker-tag }}

      - name: ðŸ“Š Resolve DVC version
        id: data
        uses: OpenCloudHub/.github/.github/actions/resolve-dvc-version@main
        with:
          dataset: ${{ inputs.dvc-dataset }}
          version: ${{ inputs.dvc-version }}
          dvc-repo: ${{ vars.DVC_REPO_URL }}

      # Simulate what a real workflow would do
      - name: ðŸš€ Simulate Argo Workflow Submission
        run: |
          echo "========================================="
          echo "ðŸ§ª INTEGRATION TEST - Simulated Submission"
          echo "========================================="
          echo ""
          echo "Would submit Argo workflow with:"
          echo "  - Image: ${{ steps.image.outputs.full-image }}"
          echo "  - Data:  ${{ steps.data.outputs.full-tag }}"
          echo ""
          echo "Available tools:"
          echo "  - kubectl: $(which kubectl)"
          echo "  - argo:    $(which argo)"
          echo ""
          echo "Cluster status:"
          kubectl get nodes
          echo ""
          echo "Argo status:"
          argo list -n mlops --limit 3 || echo "(empty)"
          echo ""
          echo "========================================="
          echo "âœ… Integration test passed!"
          echo "========================================="
          
          echo "### âœ… Integration Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All actions work together correctly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resolved values:**" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ steps.image.outputs.full-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Data: \`${{ steps.data.outputs.full-tag }}\`" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: ðŸ“‹ Test Summary
    runs-on: self-hosted-local
    if: always()
    needs: [test-kubectl, test-argo, test-docker-tag, test-dvc-version, test-integration]
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| setup-kubectl | ${{ needs.test-kubectl.result == 'success' && 'âœ… Passed' || needs.test-kubectl.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| setup-argo | ${{ needs.test-argo.result == 'success' && 'âœ… Passed' || needs.test-argo.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| resolve-docker-tag | ${{ needs.test-docker-tag.result == 'success' && 'âœ… Passed' || needs.test-docker-tag.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| resolve-dvc-version | ${{ needs.test-dvc-version.result == 'success' && 'âœ… Passed' || needs.test-dvc-version.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.test-integration.result == 'success' && 'âœ… Passed' || needs.test-integration.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY